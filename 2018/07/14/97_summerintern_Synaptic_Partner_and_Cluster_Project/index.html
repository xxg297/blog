<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/blog/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/blog/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="google5b248f7b86cbcee5.html" />














  
  
  <link href="/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/blog/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/blog/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="project,neural science,summer intern,connectomics,computational neural science,deep learning,computer vision,Jeff Lichtman," />





  <link rel="alternate" href="/blog/atom.xml" title="WonderLand" type="application/atom+xml" />






<meta name="description" content="It is part of my computational task during my summer intern in Lichtman lab  It is part of the big synapse project. Also the challenge 3 of CREMI  The codes related are here: Summer_Intern/synaptic_pa">
<meta name="keywords" content="project,neural science,summer intern,connectomics,computational neural science,deep learning,computer vision,Jeff Lichtman">
<meta property="og:type" content="article">
<meta property="og:title" content="Synaptic Partner and Cluster Project">
<meta property="og:url" content="https://www.cmwonderland.com/blog/2018/07/14/97_summerintern_Synaptic_Partner_and_Cluster_Project/index.html">
<meta property="og:site_name" content="WonderLand">
<meta property="og:description" content="It is part of my computational task during my summer intern in Lichtman lab  It is part of the big synapse project. Also the challenge 3 of CREMI  The codes related are here: Summer_Intern/synaptic_pa">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://i2.tiimg.com/640680/ad617dc9489cb429.png">
<meta property="og:image" content="http://i1.fuimg.com/640680/db4521d532057170.png">
<meta property="og:image" content="http://i1.fuimg.com/640680/239c484ca9b1ab55.png">
<meta property="og:image" content="http://i1.fuimg.com/640680/c6241b5b0bf7630b.png">
<meta property="og:image" content="http://i1.fuimg.com/640680/44ce375316d09d8a.png">
<meta property="og:image" content="http://i4.fuimg.com/640680/14407c5eb5a7dc2e.png">
<meta property="og:image" content="http://i4.fuimg.com/640680/2a531757ef1d035b.png">
<meta property="og:image" content="http://i4.fuimg.com/640680/9cd40ceb9e49ebe8.png">
<meta property="og:image" content="http://i4.fuimg.com/640680/cb94994ad0869007.png">
<meta property="og:image" content="http://i4.fuimg.com/640680/abd068c68b9d05f6.png">
<meta property="og:image" content="http://i4.fuimg.com/640680/78d027d947270dee.png">
<meta property="og:image" content="http://i4.fuimg.com/640680/1f61c116cc41a292.png">
<meta property="og:image" content="http://i1.fuimg.com/640680/1da2e8575a992b08.png">
<meta property="og:image" content="http://i1.fuimg.com/640680/2216275efd0ce764.png">
<meta property="og:image" content="http://i1.fuimg.com/640680/8b04e56610dffdea.png">
<meta property="og:image" content="http://i1.fuimg.com/640680/e80d496181dafa1e.png">
<meta property="og:updated_time" content="2018-10-10T05:02:43.134Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Synaptic Partner and Cluster Project">
<meta name="twitter:description" content="It is part of my computational task during my summer intern in Lichtman lab  It is part of the big synapse project. Also the challenge 3 of CREMI  The codes related are here: Summer_Intern/synaptic_pa">
<meta name="twitter:image" content="http://i2.tiimg.com/640680/ad617dc9489cb429.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://www.cmwonderland.com/blog/2018/07/14/97_summerintern_Synaptic_Partner_and_Cluster_Project/"/>





  <title>Synaptic Partner and Cluster Project | WonderLand</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6656499bfc0e07b4e20ee4975eb85f31";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/james20141606"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub"></a>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WonderLand</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Somnium & Somniator</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/blog/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/blog/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/blog/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.cmwonderland.com/blog/blog/2018/07/14/97_summerintern_Synaptic_Partner_and_Cluster_Project/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="James Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WonderLand">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Synaptic Partner and Cluster Project</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-14T23:58:06+08:00">
                2018-07-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/projects/" itemprop="url" rel="index">
                    <span itemprop="name">projects</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/blog/2018/07/14/97_summerintern_Synaptic_Partner_and_Cluster_Project/" class="leancloud_visitors" data-flag-title="Synaptic Partner and Cluster Project">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  3,850
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  24
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>It is part of my computational task during my summer intern in Lichtman lab</p>
<ul>
<li>It is part of the big synapse project. Also the challenge 3 of <a href="https://cremi.org" target="_blank" rel="noopener">CREMI</a></li>
</ul>
<p>The codes related are here: <a href="https://github.com/james20141606/Summer_Intern/tree/master/synaptic_partner" target="_blank" rel="noopener">Summer_Intern/synaptic_partner at master · james20141606/Summer_Intern · GitHub</a></p>
<ul>
<li>Also synapse clustering is summarized here, codes related are here: <a href="https://github.com/james20141606/Summer_Intern/tree/master/synapse_cluster" target="_blank" rel="noopener">Summer_Intern/synapse_cluster at master · james20141606/Summer_Intern · GitHub</a></li>
</ul>
<a id="more"></a>
<hr>
<h1 id="first-two-weeks"><a href="#first-two-weeks" class="headerlink" title="first two weeks"></a>first two weeks</h1><h2 id="creteria"><a href="#creteria" class="headerlink" title="creteria"></a>creteria</h2><p>I try to understand the task3, I read through metrics provided by CREMI website, and find the data processing and evaluation scripts provided by Cremi organization.<br><a href="https://github.com/cremi/cremi_python/blob/master/cremi/evaluation/synaptic_partners.py" target="_blank" rel="noopener">cremi_python/synaptic_partners.py at master · cremi/cremi_python · GitHub</a>. </p>
<p>They made it very hard to use their pipeline to store and process data. Since we have our own pipeline, I only use the core function about evaluation. By rewriting the scripts I understand how to calculate F-score, it is harder to fully understand the criteria since it needs many steps to calculate, so it is essential to read the original scripts.</p>
<p>I have summarized the metrics and show it to zudi and donglai.</p>
<p><img src="http://i2.tiimg.com/640680/ad617dc9489cb429.png" alt="Markdown"></p>
<p>This means we need the location data and neuron_id for wrong partner evaluation</p>
<h3 id="steps-to-calculate-F-score"><a href="#steps-to-calculate-F-score" class="headerlink" title="steps to calculate F-score"></a>steps to calculate F-score</h3><ul>
<li>cost_matrix :<ul>
<li>pre_post_locations get pre and post location，may consider offset shift       get rec and gt location</li>
<li>pre_post_labels  get pre and post segmentation( GT neuron_id) as rec_labels  segmentation[pre]  return the pixel value of a certain coordinates for further comparison of wrong partners for further comparison of wrong partners</li>
<li>create cost matrix，find the bigger one of rec and gt location as matrix size  init value is  2*matching_threshold</li>
<li>use cost function to calculate, for every rec and gt pair, input rec_locations[i], gt_locations[j], rec_labels[i], gt_labels[j], matching_threshold</li>
<li>in cost function, set max_cost = 2*matching_threshold，fisrt if labels1 != labels2(rec_labels[i], gt_labels[j]), from pre_post_labels we can know rec and gt comes from different segmentation(neuron).return max_cost</li>
<li>cost function continue, use np.linalg.norm to calculate pre and post L2 distance, if any of it is larger than thres, return max_cost. Else return average of pre and post. i.e. if  wrong partner (rec and gt not in same seg),  or FP: succeed thres</li>
<li>if none of them happens, return average of pre and post</li>
<li>return to cost_matrix, if distance less than thres, add potential pair count by 1, through loop, cost_matrix is filled with numbers, but the loop traverse rec_locations，gt_locations, positions not traverseed is max_cost</li>
</ul>
</li>
<li>match using Hungarian method<blockquote>
<p>All detected pairs that have both annotations inside the matching areas of a ground truth pair are considered potential matches. Of all potential matches, we find true matches by solving an assignment problem minimizing the Euclidean distance. Unmatched detected pairs are considered FP, unmatched ground truth pairs FN. The final score is the F1-score of the FPs and FNs.</p>
<ul>
<li>use linear_sum_assignment(costs - np.amax(costs) - 1)  np.amax(costs) almost is max_cost(2*matching_threshold)<ul>
<li>scpiy的linear<em>sum_assignment <strong>solves assign problems</strong>, which is one of the tricky part in this criteria.<br>let X be a boolean matrix where X[i,j] =1 if row i is assigned to column j. Then the optimal assignment has cost $$min \sum_i \sum_j C</em>{ij}X_{ij}$$, it finds the minimum Euclidean distance in all potential pairs. So we can submit all locations in a random way, it doesn’t matter.<ul>
<li>retain the assigned pairs by distance less than threshold</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
</li>
<li>unmatched in rec = FP，all pairs detected by models subtracted by cost matrix’s pairs are FP</li>
<li>unmatched in gt = FN，all GT pairs subtracted by cost matrix’s pairs are FN</li>
<li>all ground truth elements - FN = TP</li>
<li>Then we can calculate fscore, precision, recall, fp, fn, filtered_matches</li>
</ul>
<h2 id="Study-others’-methods"><a href="#Study-others’-methods" class="headerlink" title="Study others’ methods"></a>Study others’ methods</h2><h4 id="1st-place"><a href="#1st-place" class="headerlink" title="1st place"></a>1st place</h4><p>Last month Funkey put a paper <strong>Synaptic partner prediction from point annotations in insect brains</strong> it is the  top in leaderboard method. They combined synapse detection and partner identification into one steps. They train a 3D Unet，directly predict directed edges formed by voxels. Balance computational resource and coverage of synaptic partner. Then calculate score of all edges from one segment to another segment. Threshold and certify candidate synapse，for candidate synapse, calculate the mass center of all related edges, getting coordinates of synapse’s pre and post.</p>
<ul>
<li>3D U-Net architecture to directly identify pairs of voxels that are pre- and postsynaptic to each other</li>
<li>formulate the problem of synaptic partner identiﬁcation as a classiﬁcation problem on long-range edges between voxels to encode <strong>both the presence of a synaptic pair and its direction</strong>. This formulation allows us to <strong>directly learn from synaptic point annotations</strong> instead of more expensive voxel-based synaptic cleft or vesicle annotations.</li>
<li>The proposed representation also allows us to learn from synaptic point annotations only, since we do not rely on labeled synaptic features, such as synaptic clefts or vesicle clouds.</li>
</ul>
<p>From fig 1we can have a connectome matrix, actually it is what the evaluation scripts do(they are written by funkey group too.)</p>
<h4 id="2nd-place-by-previous-postdoc-in-Hanspeter-group"><a href="#2nd-place-by-previous-postdoc-in-Hanspeter-group" class="headerlink" title="2nd place by previous postdoc in Hanspeter group"></a>2nd place by previous postdoc in Hanspeter group</h4><p>Use 3D convolutional neural network for two steps.<br>3D U-net+3D CNN, Use 3D U-net to learn labels by formulate a function, then prune it by 3D CNN<br><a href="https://www.dropbox.com/s/vug579prnxt454n/miccai18syn.pdf?dl=0" target="_blank" rel="noopener">https://www.dropbox.com/s/vug579prnxt454n/miccai18syn.pdf?dl=0</a><br>学习代码<a href="https://github.com/paragt/EMSynConn" target="_blank" rel="noopener">GitHub - paragt/EMSynConn: One algorithm to detect synaptic location AND connectivity, both dyadic and polyadic, in Electron Microscopy volume.</a></p>
<h4 id="4th-place-FN-is-good"><a href="#4th-place-FN-is-good" class="headerlink" title="4th place, FN is good"></a>4th place, FN is good</h4><p>Use Asymmetric Unet<br><a href="https://github.com/nicholasturner1/Synaptor" target="_blank" rel="noopener">GitHub - nicholasturner1/Synaptor: Processing voxelwise Convolutional Network output trained to predict synaptic clefts for connectomics</a></p>
<h2 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h2><p>I did some data visualization for cerebellum and CREMI data which will be used in clustering work. Also implement some computer vision algorithm for feature extraction.<a href="https://github.com/james20141606/Summer_Intern/blob/master/synapse_cluster/jupyter/visualize_cerebellum_sample.ipynb" target="_blank" rel="noopener">visualize cerebellum</a></p>
<p>I am considering to use deep learning based clustering methods, to do feature selection and clustering simultaneously. Also it is essential to consider model interpretability. </p>
<p>Resources: <a href="http://elektronn.org/" target="_blank" rel="noopener">ELEKTRONN - Convolutional Neural Network Toolkit in Python. Fast GPU acceleration and easy usage.</a> is used for generate skeletons using deep learning.</p>
<hr>
<p> Week 3<br>The main focus of week 3 is on NMJ labeling and synapse prediction project. So the progress of clustering and synaptic partner project is not much.</p>
<h2 id="cluster"><a href="#cluster" class="headerlink" title="cluster"></a>cluster</h2><p>I have further considered <strong>clustering</strong>  project. Since we will have a huge amount of data to cluster, it is a natural thought to use deep learning based clustering method, which I have mentioned last time. After discussion with donglai and zudi, they also agree we can use a (variational) auto-encoder to cluster and analyze the synapse. If have time, I may try 3D VAE to cluster the synapse, but it need some preprocessing work. We may at first align and rotate the 2D image for better results.</p>
<p>I have read some papers including<br><a href="https://arxiv.org/pdf/1610.07584.pdf" target="_blank" rel="noopener">Learning a Probabilistic Latent Space of Object Shapes via 3D Generative-Adversarial Modeling</a><br><a href="https://arxiv.org/pdf/1801.07648.pdf" target="_blank" rel="noopener">Clustering with Deep Learning:Taxonomy and New Methods</a></p>
<p>Which I thought will be useful</p>
<h2 id="synaptic-partner"><a href="#synaptic-partner" class="headerlink" title="synaptic partner"></a>synaptic partner</h2><p>I have read and summarized some paper and codes last week on synaptic partner project. This week zudi and I discuss about previous work’s strategy. We have decided that I read and study the synaptic partner codes written by a previous postdoc. </p>
<p>Now the codes is incomplete in github, later we may get the complete codes. The codes isn’t in a very good structure, and task 3 is harder and more complex than synapse prediction, so it will take me some time to fully understand the codes and make more improvements on it.</p>
<hr>
<h1 id="Week-4"><a href="#Week-4" class="headerlink" title="Week 4"></a>Week 4</h1><h2 id="synaptic-partner-1"><a href="#synaptic-partner-1" class="headerlink" title="synaptic partner"></a>synaptic partner</h2><p>This week we mainly focus on task 3, synaptic partner prediction, this is a new and more challenging task for us. Previously we never try to predict synaptic partner, so we have to understand this task and process the raw data to get the train label.</p>
<h3 id="Align-and-process-location-to-create-training-labels"><a href="#Align-and-process-location-to-create-training-labels" class="headerlink" title="Align and process location to create training labels"></a>Align and process location to create training labels</h3><p>I study and understand the synaptic partner’s identification criterion and process the location value in the same alignment steps with raw and clefts image.</p>
<ul>
<li>extract location and pre-post id, put these points in a volume</li>
<li>align the volume, padding and deal with bad slices using same strategy </li>
</ul>
<p>location is only point id, we can shift the point by first draw the point in zero array and then extract location. Each point use pre and post id to trace back. The premise is location and clefts matches, I have checked it.</p>
<p><img src="http://i1.fuimg.com/640680/db4521d532057170.png" alt="Markdown"></p>
<p><img src="http://i1.fuimg.com/640680/239c484ca9b1ab55.png" alt="Markdown"></p>
<p>Codes:</p>
<ul>
<li>alignment matlab script<br><a href="https://github.com/james20141606/Summer_Intern/blob/master/synaptic_partner/bin/T_align.m" target="_blank" rel="noopener">Summer_Intern/T_align.m at master · james20141606/Summer_Intern · GitHub</a><br>This script can align raw, clefts and location and reverse them</li>
<li>jupyter<br>Deal with pre and post processing of locations array.<br><a href="https://github.com/james20141606/Summer_Intern/blob/master/synaptic_partner/jupyter/cremi_shift.ipynb" target="_blank" rel="noopener">Summer_Intern/cremi_shift.ipynb at master · james20141606/Summer_Intern · GitHub</a></li>
</ul>
<p><strong>visualize shift results</strong></p>
<p><img src="http://i1.fuimg.com/640680/c6241b5b0bf7630b.png" alt="Markdown"></p>
<p>I also find that in A, B, C three volumes, the partner numbers differ a lot:432, 1324, 2276<br>But clefts numbers are similar:123, 131, 165</p>
<p>The align work needs many patience, I did it over ten times to ensure it is 100 percent right. The axis, scatter and imshow tradition and many steps process made it easy to make mistakes. At last I found that it is best to dilate the points in location array and visualize it using imshow uniformly to check the alignment.</p>
<h3 id="Synaptic-partner-identification-model"><a href="#Synaptic-partner-identification-model" class="headerlink" title="Synaptic partner identification model"></a>Synaptic partner identification model</h3><p>The model can be derived from synapse identification model. We also use 3D U-net and add some changes. We study Funke’s previous work, it has some strengths and drawbacks.</p>
<p>For example, they use 14 vectors to represent all possible partner vectors. And the model predict a 14 channel one-hot vector. But this methods deliberately overfits on CREMI datasets. Since we would like to develop a model to predict synaptic partners on JWR datasets, we should use a more generalized methods. But the searching space will increase a lot.</p>
<ul>
<li>dilate location point<br>for each points(so it can specify location)</li>
<li>Generate 4 channel output (binary, Z, Y, X)<br>binary for <strong>localization</strong>, and Z, Y, X for vector <strong>orientation</strong><br>We will use cosine loss to evaluate orientation<br>So this can be considered as a multi task training</li>
<li>use branched model to predict two parts<br>Output mask and vector separately.<br>A very natural thought is we can design the model further to multiply the binary channel to the orientation part as <strong>Attention mechanism</strong>, the two branched models can share weights. I use a similar architecture in another project and it works well</li>
</ul>
<p>It is hard to both predict orientation and length. So maybe we can do post-processing work: we only predict orientation, and calculate the distance from pre synapse to clefts, and add the distance to produce post synapse location.</p>
<h3 id="Hacking-toufiq’s-codes"><a href="#Hacking-toufiq’s-codes" class="headerlink" title="Hacking toufiq’s codes:"></a>Hacking toufiq’s codes:</h3><p>I also try to study and understand Toufiq’s work. I found Toufiq and Lee has done a lot on task 3 and related synapse work. They have some valuable work and codes to be recovered. So I try to find something useful to use. </p>
<p>They have a github  repo which has many useful codes for synapses. It even has codes for finding seeds etc. <a href="https://github.com/microns-ariadne/pipeline_engine/" target="_blank" rel="noopener">GitHub - microns-ariadne/pipeline_engine: reconstruction pipeline</a></p>
<p>Prediction of pre and post and segmentation(pre and post is self-labeled and segmentation is predicted) and clefts(ground truth in original dataset)</p>
<p><img src="http://i1.fuimg.com/640680/44ce375316d09d8a.png" alt="Markdown"></p>
<p>use binary dilation for gt-syn<br>Use segment_vesicle_style function</p>
<h2 id="Synapse-cluster"><a href="#Synapse-cluster" class="headerlink" title="Synapse cluster"></a>Synapse cluster</h2><p>Help siyan with 3D skeleton. Direct 3D skeleton isn’t very good since the distance of sections (30/40 nm) is a little long. Direct interpolation or dilation also works badly.</p>
<p>So I try a ICP and KNN algorithm to maximize matching of two 2D contours and find the nearest neighbor of each point in two neighbor contour. This idea originate from calculating the volume size of a 3D object. After finding each points neighbor, we can do linear interpolation to create another 9 sections for better 3D skeleton.  </p>
<p>Codes:<br><a href="https://github.com/james20141606/Summer_Intern/blob/master/synapse_cluster/jupyter/ICP_KNN.ipynb" target="_blank" rel="noopener">Summer_Intern/ICP_KNN.ipynb at master · james20141606/Summer_Intern · GitHub</a></p>
<hr>
<h1 id="Week-5-amp-6"><a href="#Week-5-amp-6" class="headerlink" title="Week 5 &amp; 6"></a>Week 5 &amp; 6</h1><h2 id="Cluster-1"><a href="#Cluster-1" class="headerlink" title="Cluster"></a>Cluster</h2><p>Use auto encoder to reconstruct synapse and cluster the latent variable. Generate missing slides, intensity, rotation, elastic to force auto-encoder learn</p>
<p>I also find a paper by FAIR:  Deep Clustering for Unsupervised Learning of Visual Features <a href="https://arxiv.org/pdf/1807.05520v1.pdf" target="_blank" rel="noopener">https://arxiv.org/pdf/1807.05520v1.pdf</a>, it proposed an end-to-end method using  deep learning for clustering. They test it on  ImageNet and outperforms the current model. Maybe it is also useful in our datasets too.</p>
<h2 id="Synaptic-partner"><a href="#Synaptic-partner" class="headerlink" title="Synaptic partner"></a>Synaptic partner</h2><h3 id="Run-and-test-a-model-to-predict-synapse-and-synaptic-partner-simultaneously"><a href="#Run-and-test-a-model-to-predict-synapse-and-synaptic-partner-simultaneously" class="headerlink" title="Run and test a model to predict synapse and synaptic partner simultaneously"></a>Run and test a model to predict synapse and synaptic partner simultaneously</h3><p>I try to understand toufiq’s paper <a href="https://arxiv.org/pdf/1807.02739.pdf" target="_blank" rel="noopener">https://arxiv.org/pdf/1807.02739.pdf</a> Detecting Synapse Location &amp; Connectivity by Signed Proximity Estimation and Pruning with Deep Nets. And rebuild the model using Keras. So we can have two different kinds of models to solve the <strong>synaptic partner problems</strong>. One is discussed before, and the other is toufiq’s model. We will compare this two model and take the advantages of two models to get better performance on CREMI.</p>
<p>I  rewrite and modify toufiq’s model using our data and understand his solutions about synaptic partner problems.<br>I apply multiple changes to the model.</p>
<ul>
<li>Change keras backend from theano to tensorflow and modify the corresponding codes.</li>
<li>Change depraceted function and update codes.</li>
<li>Change merge to concatenate, update model, conv3D </li>
</ul>
<p>The model looks like this:</p>
<p><img src="http://i4.fuimg.com/640680/14407c5eb5a7dc2e.png" alt="Markdown"></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">THEANO_FLAGS=device=cuda<span class="variable">$1</span>,floatX=float32,dnn.enabled=True,dnn.library_path=<span class="regexp">/n/</span>home05<span class="regexp">/paragt/</span>cuda<span class="regexp">/lib64,dnn.include_path=/</span>n<span class="regexp">/home05/</span>paragt<span class="regexp">/cuda/i</span>nclude python -u  bin<span class="regexp">/vertebrate/</span>pixel<span class="regexp">/unet_3d_valid_unnorm_leaky_f24.py --trial=kasthuri_synapse_polarity_full_linear_leaky_f24_316_32 --imagedir=/</span>n<span class="regexp">/coxfs01/</span>paragt<span class="regexp">/test_submit/</span>ecs_synapse_polarity_full<span class="regexp">/grayscale_maps2_ac4/</span>  --gtname=<span class="regexp">/n/</span>coxfs01<span class="regexp">/paragt/</span>test_submit<span class="regexp">/ecs_synapse_polarity_full/</span>ac4_syn_polarity_both_corrected.h5 --ft=<span class="number">0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module <span class="keyword">load</span> cuda/<span class="number">9.0</span>-fasrc01</span><br><span class="line"><span class="keyword">module</span> <span class="keyword">load</span> cudnn/<span class="number">7.0</span><span class="number">.3</span>-fasrc02</span><br><span class="line"><span class="keyword">module</span> <span class="keyword">load</span> Anaconda</span><br><span class="line"><span class="keyword">source</span> ~/anaconda2/<span class="keyword">bin</span>/<span class="keyword">activate</span> kears_theano</span><br><span class="line"></span><br><span class="line">THEANO_FLAGS=device=cuda,floatX=float32,dnn.enabled=<span class="literal">True</span> python -u test_pixelwise.py <span class="comment">--imagedir test_data/grayscale_maps_half/ --savename test_data/jwr_pixelwise_polarity.h5 --modelname models/3D_unet_jwr_synapse_polarity_half_linear_leaky_f24_316_32_100000.json --weightname models/3D_unet_jwr_synapse_polarity_half_linear_leaky_f24_316_32_100000_weights.h5</span></span><br></pre></td></tr></table></figure>
<p><img src="http://i4.fuimg.com/640680/2a531757ef1d035b.png" alt="Markdown"></p>
<h3 id="post-processing"><a href="#post-processing" class="headerlink" title="post processing"></a>post processing</h3><p>Toufiq has many post processing methods and it will be useful to process our prediction. So I study his codes and implement them.</p>
<p>dilate gt-syn to have bigger region</p>
<p><img src="http://i4.fuimg.com/640680/9cd40ceb9e49ebe8.png" alt="Markdown"></p>
<p><img src="http://i4.fuimg.com/640680/cb94994ad0869007.png" alt="Markdown"></p>
<p>some functions in<br><a href="https://github.com/microns-ariadne/pipeline_engine" target="_blank" rel="noopener">https://github.com/microns-ariadne/pipeline_engine</a></p>
<ul>
<li>segment_vesicle_style<br>Segment according to the “Vesicle” algorithm  See<br><a href="http://arxiv.org/abs/1403.3724" target="_blank" rel="noopener">http://arxiv.org/abs/1403.3724</a><br>VESICLE: Volumetric Evaluation of  Synaptic Interfaces using Computer Vision at Large Scale</li>
</ul>
<p>Volumetric Evaluation of Synaptic Interfaces using Computer vision at Large Scale<br>Segment according to the “Vesicle” algorithm</p>
<p><img src="http://i4.fuimg.com/640680/abd068c68b9d05f6.png" alt="Markdown"></p>
<p>It seems the algorithm  <strong>segment_vesicle_style</strong> do some post processing to <strong>smooth the results</strong></p>
<ul>
<li>match_synapses_by_overlap(gt_syn_np, syn_seg)<br>Determine the <strong>best ground truth synapse for a detected synapse by overlap</strong>,  <strong>gt_syn_np</strong>: dilated gt synapse, <strong>syn_seg</strong>: post processed prediction<br>Return two vectors. <ul>
<li>The first vector is the matching label in d for each gt label (with zero for “not a match”). </li>
<li>The second vector is the matching label in gt for each detected label.</li>
</ul>
</li>
</ul>
<p>interactively show blend of EM and dilated prediction</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def draw_synseg(idx):</span><br><span class="line">    fig,<span class="attribute">ax</span>=plt.subplots(1,figsize=(8,8))</span><br><span class="line">    pylab.imshow(img[idx], <span class="attribute">cmap</span>=<span class="string">'gray'</span>)</span><br><span class="line">    pylab.imshow(gt_syn_np[idx], <span class="attribute">cmap</span>=<span class="string">'tab20'</span>, <span class="attribute">alpha</span>=.3)</span><br><span class="line">    pylab.colorbar()</span><br><span class="line">    pylab.show()</span><br><span class="line">interact(draw_synseg, idx=(0, 144))</span><br></pre></td></tr></table></figure>
<p>Dilated GT</p>
<p><img src="http://i4.fuimg.com/640680/78d027d947270dee.png" alt="Markdown"></p>
<p>post processed prediction</p>
<p><img src="http://i4.fuimg.com/640680/1f61c116cc41a292.png" alt="Markdown"></p>
<hr>
<p>Last three weeks<br>Week 7,8,9 (10)</p>
<p>Continue to improve synaptic partners model. It first uses a 3D U-net  to generates candidate synaptic connections from voxel-wise predictions of signed proximities. A second 3D CNN then prunes the set of candidates to produce the final detection of cleft and polar. </p>
<p>The U-net first generates candidate with many false positives</p>
<p><img src="http://i1.fuimg.com/640680/1da2e8575a992b08.png" alt="Markdown"></p>
<p>Then the 3D CNN uses EM image, predicted candidate and segmentation to classify if a candidate is a syanpse or not.</p>
<p><img src="http://i1.fuimg.com/640680/2216275efd0ce764.png" alt="Markdown"></p>
<hr>
<h4 id="use-bin-vertebrate-pixel-test-py-to-generate-candidate"><a href="#use-bin-vertebrate-pixel-test-py-to-generate-candidate" class="headerlink" title="use bin/vertebrate/pixel/test.py to generate candidate"></a>use bin/vertebrate/pixel/test.py to generate candidate</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">THEANO_FLAGS=device=cuda<span class="variable">$1</span>,floatX=float32,dnn.enabled=True,dnn.library_path=<span class="regexp">/n/</span>home05<span class="regexp">/paragt/</span>cuda<span class="regexp">/lib64,dnn.include_path=/</span>n<span class="regexp">/home05/</span>paragt<span class="regexp">/cuda/i</span>nclude python -u bin<span class="regexp">/vertebrate/</span>pixel<span class="regexp">/test.py --imagedir  vol3_pngspad/</span> --savename jwrprediction<span class="regexp">/jwr_pixelwise_polarity_vol3.h5 --modelname models/</span><span class="number">3</span>D_unet_jwr_synapse_polarity_half_linear_leaky_f24_316_32_100000.json --weightname models<span class="regexp">/3D_unet_jwr_synapse_polarity_half_linear_leaky_f24_316_32_100000_weights.h5</span></span><br></pre></td></tr></table></figure>
<p>test_pixel_wise.py 是bin/vertebrate/pixel/test.py</p>
<ul>
<li>imagedir  /n/coxfs01/xupeng/projects/EMSynConn-master/vol3_image</li>
<li>imagedir   /zudi_data/jwr-test/grayscale_maps_half/image_00105.png</li>
<li>savename </li>
<li>modelname   JWR_annotation/trained_models/Toufiq/keras1/3D_unet_jwr_synapse_polarity_half_linear_leaky_f24_316_32_100000.json</li>
<li>weightname  JWR_annotation/trained_models/Toufiq/keras1/3D_unet_jwr_synapse_polarity_half_linear_leaky_f24_316_32_100000_weights.h5</li>
</ul>
<p>Must keep the following parameters, so we should do padding on jwr data.</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">patchSize</span> = <span class="number">316</span></span><br><span class="line"><span class="attr">patchSize_out</span> = <span class="number">228</span></span><br><span class="line"><span class="attr">patchZ</span> = <span class="number">32</span></span><br><span class="line"><span class="attr">patchZ_out</span> = <span class="number">4</span></span><br></pre></td></tr></table></figure>
<h4 id="8-28-CNN"><a href="#8-28-CNN" class="headerlink" title="8.28 CNN"></a>8.28 CNN</h4><h5 id="Step1"><a href="#Step1" class="headerlink" title="Step1"></a>Step1</h5><p>Test.py in <strong>bin/candidate/pixel/test.py</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># add all other SBATCH directives here...</span></span><br><span class="line"><span class="comment">#SBATCH -p seas_dgx1 </span></span><br><span class="line"><span class="comment">#SBATCH --gres=gpu:1</span></span><br><span class="line"><span class="comment">#SBATCH -n 1 # Number of cores</span></span><br><span class="line"><span class="comment">#SBATCH -N 1 # Ensure that all cores are on one machine                        </span></span><br><span class="line"><span class="comment">#SBATCH --mem=60000</span></span><br><span class="line"><span class="comment">#SBATCH -t 3-0:00:00</span></span><br><span class="line"><span class="comment">#SBATCH -o jwr_candidate_prune.log</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">pred_thd_start</span>=-0.5</span><br><span class="line"><span class="attribute">iteration_start</span>=21500</span><br><span class="line"><span class="keyword">for</span> ((<span class="attribute">imultiple</span>=0;imultiple&lt;20;imultiple++));</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="attribute">iteration1</span>=`echo <span class="variable">$iteration_start</span> + 500*<span class="variable">$imultiple</span> | bc -l`</span><br><span class="line"><span class="attribute">model_name</span>=kasthuri_val_seg_trial_0.3_o100_leaky_f24_160_16_122K_unbiased/syn_prune_kasthuri_val_seg_trial_0.3_o100_leaky_f24_160_16_122K_unbiased_$&#123;iteration1&#125;.json</span><br><span class="line">    <span class="attribute">weightname</span>=kasthuri_val_seg_trial_0.3_o100_leaky_f24_160_16_122K_unbiased/sys_prune_kasthuri_val_seg_trial_0.3_o100_leaky_f24_160_16_122K_unbiased_$&#123;iteration1&#125;_weights.h5</span><br><span class="line">    echo model <span class="variable">$model_name</span></span><br><span class="line">    echo weight <span class="variable">$weightname</span></span><br><span class="line">    echo threshold <span class="variable">$pred_thd</span></span><br><span class="line">    <span class="attribute">THEANO_FLAGS</span>=device=cuda,floatX=float32,dnn.enabled=True python -u test.py  <span class="attribute">--trial</span>=jwrdata_candidate_prune <span class="attribute">--datadir</span>=kasthuri_test_files <span class="attribute">--imagedir</span>=grayscale_maps2_cropped <span class="attribute">--predname</span>=ac3_synapse-polarity_full_linear_leaky_f24_316_32_122500.h5 --syn_gtname ac3_syn_groundtruth_cropped.h5  <span class="attribute">--segname</span>=ac3-seg_m.h5 --seg_gtname ac3_seg_groundtruth_cropped.h5  <span class="attribute">--inputSize_xy</span>=160 <span class="attribute">--inputSize_z</span>=16 --modelname <span class="variable">$model_name</span>  --weightname <span class="variable">$weightname</span>  --cleft_label</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line">exit 0;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="Step2"><a href="#Step2" class="headerlink" title="Step2"></a>Step2</h5><p>First generate proposals</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># add all other SBATCH directives here...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#SBATCH -p cox</span></span><br><span class="line"><span class="comment">#SBATCH -n 1 # Number of cores</span></span><br><span class="line"><span class="comment">#SBATCH -N 1 # Ensure that all cores are on one machine                        </span></span><br><span class="line"><span class="comment">#SBATCH --mem=60000</span></span><br><span class="line"><span class="comment">#SBATCH -t 3-00:00:00</span></span><br><span class="line"><span class="comment">#SBATCH -o ecs_synapse_multiclass_f24_316_32_%j.log</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">iter=<span class="number">150000</span></span><br><span class="line">python generate_proposals.py  --trial test_seg_trial_0.<span class="number">3</span>_o100_leaky_f24_160_16 --datadir test_files --imagedir grayscale_maps2_tst4x6x6 --predname test_ecs_synapse_polarity_full_margin_linear_leaky_f24_316_32_196000-cropped.h5  --syn_gtname ecs-syn-tst-groundtruth-polarity.h5  --segname result_ecs-<span class="number">4</span>x6x6-<span class="number">100</span>K-<span class="number">40000</span>-itr3-thd0.<span class="number">1</span>_xml_m.h5  --seg_gtname seg_groundtruth0.h5  --inputSize_xy=<span class="number">160</span> --inputSize_z=<span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<h5 id="Step3"><a href="#Step3" class="headerlink" title="Step3"></a>Step3</h5><p><strong>submit_test_dgx_kasthuri.sh</strong>  test.py  do prediction</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># add all other SBATCH directives here...</span></span><br><span class="line"><span class="comment">#SBATCH -p seas_dgx1 </span></span><br><span class="line"><span class="comment">#SBATCH --gres=gpu:1</span></span><br><span class="line"><span class="comment">#SBATCH -n 1 # Number of cores</span></span><br><span class="line"><span class="comment">#SBATCH -N 1 # Ensure that all cores are on one machine                        </span></span><br><span class="line"><span class="comment">#SBATCH --mem=60000</span></span><br><span class="line"><span class="comment">#SBATCH -t 3-0:00:00</span></span><br><span class="line"><span class="comment">#SBATCH -o ecs_test_316_32_%j.log</span></span><br><span class="line">source ~/anaconda2/bin/activate kears_theano</span><br><span class="line"></span><br><span class="line"><span class="attribute">pred_thd_start</span>=-0.5</span><br><span class="line"><span class="attribute">iteration_start</span>=21500</span><br><span class="line"><span class="keyword">for</span> ((<span class="attribute">imultiple</span>=0;imultiple&lt;20;imultiple++));</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="attribute">iteration1</span>=`echo <span class="variable">$iteration_start</span> + 500*<span class="variable">$imultiple</span> | bc -l`</span><br><span class="line"><span class="attribute">model_name</span>=kasthuri_val_seg_trial_0.3_o100_leaky_f24_160_16_122K_unbiased/syn_prune_kasthuri_val_seg_trial_0.3_o100_leaky_f24_160_16_122K_unbiased_$&#123;iteration1&#125;.json</span><br><span class="line">    <span class="attribute">weightname</span>=kasthuri_val_seg_trial_0.3_o100_leaky_f24_160_16_122K_unbiased/sys_prune_kasthuri_val_seg_trial_0.3_o100_leaky_f24_160_16_122K_unbiased_$&#123;iteration1&#125;_weights.h5</span><br><span class="line">    echo model <span class="variable">$model_name</span></span><br><span class="line">    echo weight <span class="variable">$weightname</span></span><br><span class="line">    echo threshold <span class="variable">$pred_thd</span></span><br><span class="line">    <span class="attribute">THEANO_FLAGS</span>=device=cuda,floatX=float32,dnn.enabled=True python -u test.py  <span class="attribute">--trial</span>=kasthuri_test_seg_trial_0.3_o100_leaky_f24_160_16_122K <span class="attribute">--datadir</span>=kasthuri_test_files <span class="attribute">--imagedir</span>=grayscale_maps2_cropped <span class="attribute">--predname</span>=ac3_synapse-polarity_full_linear_leaky_f24_316_32_122500.h5 --syn_gtname ac3_syn_groundtruth_cropped.h5  <span class="attribute">--segname</span>=ac3-seg_m.h5 --seg_gtname ac3_seg_groundtruth_cropped.h5  <span class="attribute">--inputSize_xy</span>=160 <span class="attribute">--inputSize_z</span>=16 --modelname <span class="variable">$model_name</span>  --weightname <span class="variable">$weightname</span>  --cleft_label</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line">exit 0;</span><br></pre></td></tr></table></figure>
<p><strong>run_unet_06_f24_kasthuri.sh</strong>  train a unet_3d_valid_unnorm_leaky_f24 model</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">THEANO_FLAGS=device=gpu<span class="variable">$1</span>,floatX=float32,dnn.enabled=True,dnn.library_path=<span class="regexp">/n/</span>home05<span class="regexp">/paragt/</span>cuda<span class="regexp">/lib64,dnn.include_path=/</span>n<span class="regexp">/home05/</span>paragt<span class="regexp">/cuda/i</span>nclude python -u  unet_3d_valid_unnorm_leaky_f24.py --trial=kasthuri_synapse_polarity_full_linear_leaky_f24_316_32 --imagedir=<span class="regexp">/n/</span>coxfs01<span class="regexp">/paragt/</span>test_submit<span class="regexp">/ecs_synapse_polarity_full/g</span>rayscale_maps2_ac4<span class="regexp">/  --gtname=/</span>n<span class="regexp">/coxfs01/</span>paragt<span class="regexp">/test_submit/</span>ecs_synapse_polarity_full<span class="regexp">/ac4_syn_polarity_both_corrected.h5</span></span><br></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">pred_thd_start</span>=-0.5</span><br><span class="line"><span class="attribute">iteration_start</span>=21500</span><br><span class="line"><span class="keyword">for</span> ((<span class="attribute">imultiple</span>=0;imultiple&lt;20;imultiple++));</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="attribute">iteration1</span>=`echo <span class="variable">$iteration_start</span> + 500*<span class="variable">$imultiple</span> | bc -l`</span><br><span class="line"><span class="attribute">model_name</span>=kasthuri_val_seg_trial_0.3_o100_leaky_f24_160_16_122K_unbiased/syn_prune_kasthuri_val_seg_trial_0.3_o100_leaky_f24_160_16_122K_unbiased_$&#123;iteration1&#125;.json</span><br><span class="line">    <span class="attribute">weightname</span>=kasthuri_val_seg_trial_0.3_o100_leaky_f24_160_16_122K_unbiased/sys_prune_kasthuri_val_seg_trial_0.3_o100_leaky_f24_160_16_122K_unbiased_$&#123;iteration1&#125;_weights.h5</span><br><span class="line">    echo model <span class="variable">$model_name</span></span><br><span class="line">    echo weight <span class="variable">$weightname</span></span><br><span class="line">    echo threshold <span class="variable">$pred_thd</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>We compare the model with SynEM on Kasthuri data. The model makes better prediction.</p>
<p><img src="http://i1.fuimg.com/640680/8b04e56610dffdea.png" alt="Markdown"></p>
<p>We will also test another model, Resnet+U-net, originated from task2 and it has many improvements in this summer.<br>It includes dilation CNN, batch normalization for multi-GPU, squeeze-and-excitation block. For polarity prediction, now the pixel can be either background, pre-synapse or post-synapse, so we can adapt the model to 3 channel  output. And we can change the loss function to MSE.</p>
<p><img src="http://i1.fuimg.com/640680/e80d496181dafa1e.png" alt="Markdown"></p>
<p>It has better generalization than what Funke’s group’s model since they over fit the CREMI dataset. It performs well on JWR data.</p>
<p>I will apply our model to predict synEM data. Thus we both test synEM model on our data and test our model on their data, this will give us enough result to compare our model.</p>
<p>SynEM data has four channels, using different size of synapse. We only use the small polarity for post synapse and large for pre synapse.<br>[image:F10F22C4-AAA4-4868-B496-BF7DB0A73A97-385-0000D376F35FA1C0/屏幕快照 2018-09-04 下午5.27.40.png]</p>
<p><code>env create -f bin/synapse_pytorch/envs/py3_pytorch.yml</code></p>
<p><code>source activate py3_pytorch</code></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source activate py3_pytorch</span><br><span class="line">CUDA_VISIBLE_DEVICES=<span class="number">0</span> python3 -u bin/synapse_pytorch/train_sync_polarity.py -t /n/coxfs01/xupeng/projects/synapse/data/synEM/synEM_train_data/ -dn raw/synEM_train_raw_000.h5 -ln label_new/synEM_train_label_new_channel_000.h5 -o outputs/<span class="number">9.6</span>_single -lr <span class="number">1e-03</span> --volume-total <span class="number">1600000</span> --volume-save <span class="number">100000</span> -mi <span class="number">8</span>,<span class="number">160</span>,<span class="number">160</span> -g <span class="number">1</span> -c <span class="number">1</span> -b <span class="number">1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source activate py3_pytorch</span><br><span class="line">CUDA_VISIBLE_DEVICES=<span class="number">0</span> python3 -u bin/synapse_pytorch/train_sync_polarity.py -t data/synEM/synEM/synEM_train_data/ -dn raw/synEM_train_raw_000.h5 -ln label_new/synEM_train_label_new_channel_000.h5 -o outputs/<span class="number">9.6</span>_single -lr <span class="number">1e-03</span> --volume-total <span class="number">1600000</span> --volume-save <span class="number">100000</span> -mi <span class="number">8</span>,<span class="number">160</span>,<span class="number">160</span> -g <span class="number">1</span> -c <span class="number">1</span> -b <span class="number">1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source activate py3_pytorch</span><br><span class="line">CUDA_VISIBLE_DEVICES=<span class="number">0</span> python3 -u bin/synapse_pytorch/train_sync_polarity.py -t /n/coxfs01/zudilin/research/data/JWR/syn_vol1/ -dn im.h5 -ln jwr_syn_polarity.h5 -o outputs/<span class="number">9.10</span>_single -lr <span class="number">1e-03</span> --volume-total <span class="number">1600000</span> --volume-save <span class="number">100000</span> -mi <span class="number">8</span>,<span class="number">160</span>,<span class="number">160</span> -g <span class="number">1</span> -c <span class="number">1</span> -b <span class="number">1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source activate py3_pytorch</span><br><span class="line">CUDA_VISIBLE_DEVICES=<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span> python3 -u bin/synapse_pytorch/train_sync_polarity.py -t /n/coxfs01/xupeng/projects/synapse/data/synEM/synEM_train_data/ -dn raw/synEM_train_raw_000.h5@raw/synEM_train_raw_001.h5@raw/synEM_train_raw_002.h5 -ln label_new/synEM_train_label_new_channel_000.h5@label_new/synEM_train_label_new_channel_001.h5@label_new/synEM_train_label_new_channel_002.h5 -o outputs/<span class="number">9.6</span> -lr <span class="number">1e-03</span> --volume-total <span class="number">1600000</span> --volume-save <span class="number">100000</span> -mi <span class="number">8</span>,<span class="number">160</span>,<span class="number">160</span> -g <span class="number">3</span> -c <span class="number">3</span> -b <span class="number">3</span></span><br></pre></td></tr></table></figure>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># add all other SBATCH directives here...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#SBATCH -p cox</span></span><br><span class="line"><span class="comment">#SBATCH --gres=gpu:8</span></span><br><span class="line"><span class="comment">#SBATCH --constraint=titanx</span></span><br><span class="line"><span class="comment">#SBATCH -n 8 # Number of cores</span></span><br><span class="line"><span class="comment">#SBATCH -N 1 # Ensure that all cores are on one machine</span></span><br><span class="line"><span class="comment">#SBATCH --mem=50000</span></span><br><span class="line"><span class="comment">#SBATCH -t 5-00:00:00</span></span><br><span class="line"><span class="comment">#SBATCH -o logs/train_%j.log</span></span><br><span class="line"></span><br><span class="line">module load cuda</span><br><span class="line">source activate py3_pytorch</span><br><span class="line"></span><br><span class="line">CUDA_VISIBLE_DEVICES=<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span> python3 -u bin<span class="regexp">/synapse_pytorch/</span>train_sync_polarity.py -t <span class="regexp">/n/</span>coxfs01<span class="regexp">/xupeng/</span>projects<span class="regexp">/synapse/</span>data<span class="regexp">/synEM/</span>synEM_train_data<span class="regexp">/ -dn raw/</span>synEM_train_raw_000.h5@raw<span class="regexp">/synEM_train_raw_001.h5@raw/</span>synEM_train_raw_002.h5@raw<span class="regexp">/synEM_train_raw_003.h5@raw/</span>synEM_train_raw_004.h5@raw<span class="regexp">/synEM_train_raw_005.h5@raw/</span>synEM_train_raw_006.h5@raw<span class="regexp">/synEM_train_raw_007.h5@raw/</span>synEM_train_raw_008.h5@raw<span class="regexp">/synEM_train_raw_009.h5 -ln label_new/</span>synEM_train_label_new_channel_000.h5@label_new<span class="regexp">/synEM_train_label_new_channel_001.h5@label_new/</span>synEM_train_label_new_channel_002.h5@label_new<span class="regexp">/synEM_train_label_new_channel_003.h5@label_new/</span>synEM_train_label_new_channel_004.h5@label_new<span class="regexp">/synEM_train_label_new_channel_005.h5@label_new/</span>synEM_train_label_new_channel_006.h5@label_new<span class="regexp">/synEM_train_label_new_channel_007.h5@label_new/</span>synEM_train_label_new_channel_008.h5@label_new<span class="regexp">/synEM_train_label_new_channel_009.h5 -o outputs/</span><span class="number">9.5</span>_10_volumes -lr <span class="number">1</span>e-<span class="number">03</span> --volume-total <span class="number">1600000</span> --volume-save <span class="number">100000</span> -mi <span class="number">8</span>,<span class="number">160</span>,<span class="number">160</span> -g <span class="number">8</span> -c <span class="number">8</span> -b <span class="number">32</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># end of program</span></span><br><span class="line"><span class="keyword">exit</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    <div>
    
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-----The ---- end ----<i class="fa fa-paw"></i>--- Thanks --- for --- Reading----</div>
    
</div>

    
    </div>

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/blog/tags/project/" rel="tag"><i class="fa fa-tag"></i> project</a>
          
            <a href="/blog/tags/neural-science/" rel="tag"><i class="fa fa-tag"></i> neural science</a>
          
            <a href="/blog/tags/summer-intern/" rel="tag"><i class="fa fa-tag"></i> summer intern</a>
          
            <a href="/blog/tags/connectomics/" rel="tag"><i class="fa fa-tag"></i> connectomics</a>
          
            <a href="/blog/tags/computational-neural-science/" rel="tag"><i class="fa fa-tag"></i> computational neural science</a>
          
            <a href="/blog/tags/deep-learning/" rel="tag"><i class="fa fa-tag"></i> deep learning</a>
          
            <a href="/blog/tags/computer-vision/" rel="tag"><i class="fa fa-tag"></i> computer vision</a>
          
            <a href="/blog/tags/Jeff-Lichtman/" rel="tag"><i class="fa fa-tag"></i> Jeff Lichtman</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2018/07/14/98_summerintern_Synapse_Prediction/" rel="next" title="Synapse Prediction Project">
                <i class="fa fa-chevron-left"></i> Synapse Prediction Project
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/2018/08/16/95_medical_image_project/" rel="prev" title="Deep Learning in Medical Image">
                Deep Learning in Medical Image <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/blog/images/avatar.png"
                alt="James Chen" />
            
              <p class="site-author-name" itemprop="name">James Chen</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/blog/archives/">
              
                  <span class="site-state-item-count">70</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/blog/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/blog/tags/index.html">
                  <span class="site-state-item-count">68</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/blog/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/james20141606" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:xp-chen14@mails.tsinghua.edu.cn" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#first-two-weeks"><span class="nav-number">1.</span> <span class="nav-text">first two weeks</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#creteria"><span class="nav-number">1.1.</span> <span class="nav-text">creteria</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#steps-to-calculate-F-score"><span class="nav-number">1.1.1.</span> <span class="nav-text">steps to calculate F-score</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Study-others’-methods"><span class="nav-number">1.2.</span> <span class="nav-text">Study others’ methods</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1st-place"><span class="nav-number">1.2.0.1.</span> <span class="nav-text">1st place</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2nd-place-by-previous-postdoc-in-Hanspeter-group"><span class="nav-number">1.2.0.2.</span> <span class="nav-text">2nd place by previous postdoc in Hanspeter group</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4th-place-FN-is-good"><span class="nav-number">1.2.0.3.</span> <span class="nav-text">4th place, FN is good</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cluster"><span class="nav-number">1.3.</span> <span class="nav-text">Cluster</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cluster"><span class="nav-number">1.4.</span> <span class="nav-text">cluster</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#synaptic-partner"><span class="nav-number">1.5.</span> <span class="nav-text">synaptic partner</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Week-4"><span class="nav-number">2.</span> <span class="nav-text">Week 4</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#synaptic-partner-1"><span class="nav-number">2.1.</span> <span class="nav-text">synaptic partner</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Align-and-process-location-to-create-training-labels"><span class="nav-number">2.1.1.</span> <span class="nav-text">Align and process location to create training labels</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Synaptic-partner-identification-model"><span class="nav-number">2.1.2.</span> <span class="nav-text">Synaptic partner identification model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hacking-toufiq’s-codes"><span class="nav-number">2.1.3.</span> <span class="nav-text">Hacking toufiq’s codes:</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Synapse-cluster"><span class="nav-number">2.2.</span> <span class="nav-text">Synapse cluster</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Week-5-amp-6"><span class="nav-number">3.</span> <span class="nav-text">Week 5 &amp; 6</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Cluster-1"><span class="nav-number">3.1.</span> <span class="nav-text">Cluster</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Synaptic-partner"><span class="nav-number">3.2.</span> <span class="nav-text">Synaptic partner</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Run-and-test-a-model-to-predict-synapse-and-synaptic-partner-simultaneously"><span class="nav-number">3.2.1.</span> <span class="nav-text">Run and test a model to predict synapse and synaptic partner simultaneously</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#post-processing"><span class="nav-number">3.2.2.</span> <span class="nav-text">post processing</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#use-bin-vertebrate-pixel-test-py-to-generate-candidate"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">use bin/vertebrate/pixel/test.py to generate candidate</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-28-CNN"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">8.28 CNN</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Step1"><span class="nav-number">3.2.2.2.1.</span> <span class="nav-text">Step1</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Step2"><span class="nav-number">3.2.2.2.2.</span> <span class="nav-text">Step2</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Step3"><span class="nav-number">3.2.2.2.3.</span> <span class="nav-text">Step3</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">James Chen</span>

  
</div>



  <span class="post-meta-divider">|</span>




<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共146.6k字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  



  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("klOjl0RBA8qP5IKgIXkOszBr-gzGzoHsz", "rCaN5wX4mjiRkRMzP95g7XHz");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  
  


  

  

  
</body>
</html>
